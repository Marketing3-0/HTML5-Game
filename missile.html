<!DOCTYPE html>
<html>
<head>
	<script language="javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js" type="text/javascript"></script>
	<script language="javascript" src="jquery.hotkeys.js"></script>
	<script language="javascript" src="key_status.js"></script>
	<script language="javascript" src="sprite.js"></script>
	<style type="text/css" media="screen">
		canvas, img { display:block; margin:1em auto; border:1px solid black; }
		canvas { background:url(images/bg.png) }
	</style>
	<title>Space Shooter</title>
</head>
<body>
	<script type="text/javascript">
		var CANVAS_WIDTH = 720;
		var CANVAS_HEIGHT = 480;

		var canvasElement = $("<canvas width='" + CANVAS_WIDTH + 
							  "' height='" + CANVAS_HEIGHT + "'></canvas>");
		var canvas = canvasElement.get(0).getContext("2d");
		canvasElement.appendTo('body');
		
		var playerBullets = [];
		var enemies = [];
		var sky = new Image();
		sky.src = "images/scrollingbg.png";
		var skyy = 0, skydy = 1;
		var FPS = 30;
		var gameLoop;
		
		var startGameLoop = function() {
			if(player) {
				if(!player.active) {
					// If the game is over, reset it
					player.x = 220;
					player.y = 370;
					player.active = true;
				}
			}
			gameLoop = setInterval(function() {
				update();
				draw();
				}, 1000/FPS);
		}
		startGameLoop();
		
		Number.prototype.clamp = function(min, max) {
			return Math.min(Math.max(this, min), max);
		};
		
		function update() {
			if (keydown.space) {
				if(!player.charging){
					player.charging = true;
					player.shoot();
				}
			}
			
			if(keydown.shift) {
				if(gameLoop) {
					canvas.font = '48px';
					canvas.fillStyle = "Red";
					canvas.fillText("PAUSED", 200, 200);
					clearInterval(gameLoop);
					gameLoop = 0;
				}
				else startGameLoop();
			}
			
			if (keydown.left) {
				player.x -= 5;
				player.sprite = player.leftsprite;
			}
			else player.sprite = player.straightsprite;
			
			if (keydown.right) {
				player.x += 5;
				player.sprite = player.rightsprite;
			}
			else if (!keydown.left) player.sprite = player.straightsprite;
			
			if (keydown.up) {
				player.y -= 5;
			}

			if (keydown.down) {
				player.y += 5;
			}
			
			player.x = player.x.clamp(0, CANVAS_WIDTH - player.width);
			player.y = player.y.clamp(100, CANVAS_HEIGHT - player.height*2);
			
			// Update our location in the background image
			if ((skyy + skydy) < (430 - skydy)){ 
				skyy += skydy; 
			}
			else {
				skyy = 0;
			}
			
			playerBullets.forEach(function(bullet) {
				bullet.update();
			});

			playerBullets = playerBullets.filter(function(bullet) {
				return bullet.active;
			});
			
			enemies.forEach(function(enemy) {
				enemy.update();
			});

			enemies = enemies.filter(function(enemy) {
				return enemy.active;
			});

			handleCollisions();
			// Player death, game over
			if(!player.active) {
				player.sprite = player.deathsprite;
				canvasElement.get(0).onclick = startGameLoop;
				clearInterval(gameLoop);
			}
			var enemySeed = Math.random();
			if(enemySeed < 0.05) {
				enemies.push(Enemy());
			}
			if (enemySeed < .005) {
				enemies.push(Enemy(Enemy(), 'B'));
			}
			if (enemySeed < .003) {
				enemies.push(Enemy(Enemy(), 'C'));
			}
		}

		function draw() {
			canvas.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
			
			canvas.drawImage(sky, 0, skyy, 720, 480, 0, 0, 720, 480);
			
			player.draw();
			
			playerBullets.forEach(function(bullet) {
				bullet.draw();
			});
			
			enemies.forEach(function(enemy) {
				enemy.draw();
			});
		}
		
		var player = {
			color: "#00A",
			x: 220,
			y: 370,
			width: 32,
			height: 32,
			rateOfFire: 200,
			active: true,
			charging: false,
			draw: function() {
				this.sprite.draw(canvas, this.x, this.y);
			},
			shoot: function() {
				var bulletPosition = this.midpoint();
				
				setTimeout(function() { 
								player.charging = false;
								playerBullets.push(Bullet({
								speed: 5,
								x: bulletPosition.x,
								y: bulletPosition.y
								}))}, this.rateOfFire);
			},
			midpoint: function() {
				return {
					x: this.x + this.width/2,
					y: this.y + this.height/2
				};
			}
		};
		
		player.sprite = Sprite("player.png");
		player.leftsprite = Sprite("shipLeft.png");
		player.rightsprite = Sprite("shipRight.png");
		player.straightsprite = Sprite("player.png");
		player.deathsprite = Sprite("explosion.png");
		
		player.explode = function() {
			this.active = false;
		};
		
		function Bullet(I) {
			I.active = true;

			I.xVelocity = 0;
			I.yVelocity = -I.speed;
			I.width = 5;
			I.height = 5;
			I.color = "#000";
			I.sprite = Sprite("playerFireball.png");
			
			I.inBounds = function() {
				return I.x >= 0 && I.x <= CANVAS_WIDTH &&
					I.y >= 0 && I.y <= CANVAS_HEIGHT;
			};

			I.draw = function() {
				if(I.active)
					this.sprite.draw(canvas, this.x, this.y);
			};

			I.update = function() {
				I.x += I.xVelocity;
				I.y += I.yVelocity;

				I.active = I.active && I.inBounds();
			};

			return I;
		}

		function Enemy(I, type) {
			I = I || {};
			I.type = type;
			I.active = true;
			I.age = Math.floor(Math.random() * 128);

			I.x = CANVAS_WIDTH / 4 + Math.random() * CANVAS_WIDTH / 2;
			I.y = 0;
			I.xVelocity = 0
			I.yVelocity = 2;

			I.width = 32;
			I.height = 32;
			I.sprite = Sprite("enemy.png");
			I.deathsprite = Sprite("explosion.png");
			
			if((I.type === 'B') || (I.type === 'C')) {
				var pickSide = Math.random();
				if(pickSide < .5) {
					if(I.type === 'B') {
						// Enemy B Heading Left
						I.sprite = Sprite("greenEnemyLeft.png");
						I.x = CANVAS_WIDTH-I.width;
						I.xVelocity = -8;
						I.y = player.y;
					}
					else if(I.type === 'C') {
						// Enemy C Heading Left
						I.sprite = Sprite("Wily.png");
						I.x = CANVAS_WIDTH-I.width;
						I.xVelocity = -2;
					}
				}
				else {
					if(I.type === 'B') {
						// Enemy B Heading Right
						I.sprite = Sprite("greenEnemy.png");
						I.x = 0;
						I.xVelocity = 8;
						I.y = player.y;
					}
					else if(I.type === 'C') {
						// Enemy C Heading Right
						I.sprite = Sprite("Wily.png");
						I.x = 0;
						I.xVelocity = 2;
						I.width = 70;
					}
				}
				I.yVelocity = 0;
			}
			else if (I.type === 'P') {
					// Enemy C's projectiles
					I.xVelocity = 0;
					I.sprite = Sprite("enemyFireball.png");
			}
			I.inBounds = function() {
				return I.x >= 0 && I.x <= CANVAS_WIDTH &&
					I.y >= 0 && I.y <= CANVAS_HEIGHT;
			};

			I.draw = function() {
				this.sprite.draw(canvas, this.x, this.y);
			};

			I.update = function() {
				I.x += I.xVelocity;
				I.y += I.yVelocity;
				
				if(!this.type)
					I.xVelocity = 3 * Math.sin(I.age * Math.PI / 64);

				I.age++;
				
				// C Type enemies have a chance to drop bombs
				if(this.type === 'C') {
					var fireChance = Math.random();
					if(fireChance < .02) {
						// Drop a bomb towards the player
						var projectile = Enemy(Enemy(), 'P');
						projectile.x = this.x;
						projectile.y = this.y + this.height;
						enemies.push(projectile);
					}
				}
				
				I.active = I.active && I.inBounds();
			};

			I.explode = function() {
				this.active = false;
				I.sprite = I.deathsprite;
				// Add an explosion graphic here
			};
  
			return I;
		}; 
		
		function collides(a, b) {
			return a.x < b.x + b.width &&
					a.x + a.width > b.x &&
					a.y < b.y + b.height &&
					a.y + a.height > b.y;
		}
		
		function handleCollisions() {
			playerBullets.forEach(function(bullet) {
				enemies.forEach(function(enemy) {
					if(enemy.type !== 'P') {
						if (collides(bullet, enemy)) {
							enemy.explode();
							bullet.active = false;
						}
					}
				});
			});

			enemies.forEach(function(enemy) {
				if (collides(enemy, player)) {
					enemy.explode();
					player.explode();
				}
			});
		}
	</script>
</body>
</html>